# File update patterns for multiarch-tuning-operator version upgrades
#
# This defines the exact file patterns and regex replacements needed for upgrading
# Go and Kubernetes versions across the repository.
#
# Pattern format uses Python regex syntax with named groups for clarity.

# Step 1: Update Go version in base images
base_image_updates:
  - file: ".ci-operator.yaml"
    description: "Update CI operator builder image with Go and OCP versions"
    regex:
      pattern: "(tag:\\s+rhel-9-golang-)(\\d+\\.\\d+)((?:-builder-multi)?-openshift-)(\\d+\\.\\d+)"
      groups:
        1: "Prefix: 'rhel-9-golang-'"
        2: "Go version (e.g., '1.22')"
        3: "Separator: '-builder-multi-openshift-' or '-openshift-'"
        4: "OCP version (e.g., '4.17')"
      replacement: "$1{go_version}$3{ocp_version}"
      example:
        before: "tag: rhel-9-golang-1.22-builder-multi-openshift-4.17"
        after: "tag: rhel-9-golang-1.23-openshift-4.19"

  - file: ".tekton/*.yaml"
    description: "Update Konflux pipeline brew registry golang images"
    file_glob: ".tekton/*-integration-tests.yaml,.tekton/*-pull-request.yaml,.tekton/*-push.yaml"
    regex:
      pattern: "(brew\\.registry\\.redhat\\.io/rh-osbs/openshift-golang-builder:rhel_9_)(\\d+\\.\\d+)"
      groups:
        1: "Full image path prefix"
        2: "Go version (e.g., '1.22')"
      replacement: "$1{go_version}"
      example:
        before: "brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_1.22"
        after: "brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_1.23"
    note: ".tekton files only have Go version, not OCP version"

  - file: "Dockerfile"
    description: "Update Docker Hub golang base image"
    regex:
      pattern: "(FROM\\s+golang:)(\\d+\\.\\d+)"
      groups:
        1: "Prefix: 'FROM golang:'"
        2: "Go version (e.g., '1.22')"
      replacement: "$1{go_version}"
      example:
        before: "FROM golang:1.22"
        after: "FROM golang:1.23"
    note: "Uses Docker Hub golang images, not UBI (repository-specific pattern)"

  - file: "Makefile"
    description: "Update BUILD_IMAGE with Go and OCP versions"
    variable: "BUILD_IMAGE"
    regex:
      pattern: "(BUILD_IMAGE\\s*\\?=\\s*registry\\.ci\\.openshift\\.org/ocp/builder:rhel-9-golang-)(\\d+\\.\\d+)((?:-builder-multi)?-openshift-)(\\d+\\.\\d+)"
      groups:
        1: "Full path prefix ending in 'golang-'"
        2: "Go version (e.g., '1.22')"
        3: "Separator: '-builder-multi-openshift-' or '-openshift-'"
        4: "OCP version (e.g., '4.17')"
      replacement: "$1{go_version}$3{ocp_version}"
      example:
        before: "BUILD_IMAGE ?= registry.ci.openshift.org/ocp/builder:rhel-9-golang-1.22-builder-multi-openshift-4.17"
        after: "BUILD_IMAGE ?= registry.ci.openshift.org/ocp/builder:rhel-9-golang-1.23-openshift-4.19"
    validation: "OCP version must match the one from .ci-operator.yaml"

  - file: "bundle.konflux.Dockerfile"
    description: "Update Konflux bundle Dockerfile brew registry image"
    regex:
      pattern: "(FROM\\s+brew\\.registry\\.redhat\\.io/rh-osbs/openshift-golang-builder:rhel_9_)(\\d+\\.\\d+)"
      groups:
        1: "Full image path prefix"
        2: "Go version (e.g., '1.22')"
      replacement: "$1{go_version}"
      example:
        before: "FROM brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_1.22"
        after: "FROM brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_1.23"

  - file: "konflux.Dockerfile"
    description: "Update Konflux Dockerfile brew registry image"
    regex:
      pattern: "(FROM\\s+brew\\.registry\\.redhat\\.io/rh-osbs/openshift-golang-builder:rhel_9_)(\\d+\\.\\d+)"
      groups:
        1: "Full image path prefix"
        2: "Go version (e.g., '1.22')"
      replacement: "$1{go_version}"
      example:
        before: "FROM brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_1.22"
        after: "FROM brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_1.23"

# Step 2: Update go.mod
go_mod_updates:
  - description: "Update go directive"
    file: "go.mod"
    line_pattern: "^go \\d+\\.\\d+"
    replacement: "go {go_version}"
    example:
      before: "go 1.22"
      after: "go 1.23"

# Step 4: Update Makefile tool versions
makefile_tool_updates:
  - variable: "KUSTOMIZE_VERSION"
    description: "Kustomize version for manifest customization"
    dynamic: true
    discovery: "Latest v5.x compatible with Go version"
    reference: "https://github.com/kubernetes-sigs/kustomize/releases"

  - variable: "CONTROLLER_TOOLS_VERSION"
    description: "Controller-tools version for code generation"
    dynamic: true
    discovery: "Latest version matching K8s API version and Go version"
    reference: "https://github.com/kubernetes-sigs/controller-tools/releases"

  - variable: "SETUP_ENVTEST_VERSION"
    description: "Setup-envtest version (must match controller-runtime)"
    dynamic: true
    discovery: "Derive from controller-runtime version (release-0.{minor})"
    reference: "https://github.com/kubernetes-sigs/controller-runtime/branches"
    format: "release-{controller_runtime_minor}"
    example: "controller-runtime v0.20.x → release-0.20"

  - variable: "ENVTEST_K8S_VERSION"
    description: "Kubebuilder assets version for envtest"
    dynamic: true
    discovery: "Extract from controller-runtime's k8s.io/api dependency"
    source: "controller-runtime go.mod"
    example: "If controller-runtime uses k8s.io/api v0.34.0, use v0.34.0"

  - variable: "GOLINT_VERSION"
    description: "Golangci-lint version for linting"
    dynamic: true
    discovery: "Latest version compatible with Go version"
    reference: "https://github.com/golangci/golangci-lint/releases"

# Git commit structure
# These define the exact commit messages and file groupings for each step
commit_structure:
  - step: 1
    message: "Update Makefile and Dockerfiles to use the new Golang version base image to {go_version}"
    files:
      - ".ci-operator.yaml"
      - ".tekton/"
      - "Dockerfile"
      - "Makefile"
      - "bundle.konflux.Dockerfile"
      - "konflux.Dockerfile"
    validations:
      - "getCorrectHostmountAnyUIDSCC function K8s version logic"

  - step: 2
    message: "pin K8S API to v{k8s_version} and set go minimum version to {go_version}"
    files:
      - "go.mod"
      - "go.sum"

  - step: 3
    message: "go mod vendor"
    files:
      - "vendor/"

  - step: 4
    message: "Update tools in Makefile"
    files:
      - "Makefile"
    changes:
      - "KUSTOMIZE_VERSION"
      - "CONTROLLER_TOOLS_VERSION"
      - "SETUP_ENVTEST_VERSION"
      - "ENVTEST_K8S_VERSION"
      - "GOLINT_VERSION"

  - step: 5
    message: "Code generation after upgrade"
    files:
      - "Generated files from make generate, make manifests, make bundle"
    commands:
      - "make generate"
      - "make manifests"
      - "make bundle"

  - step: 6
    message: "Update code after Golang, pivot to k8s {k8s_version} and dependencies upgrade"
    description: "Any additional code changes needed after upgrade"
    condition: "Only if there are code changes required"

# Validation rules
validations:
  - name: "Base image existence"
    check: "All target base images exist and are accessible"
    images:
      - "golang:{go_version}"
      - "registry.ci.openshift.org/ocp/builder:rhel-9-golang-{go_version}-openshift-{ocp_version}"
      - "brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_{go_version}"

  - name: "OCP version consistency"
    check: "Same OCP version used in .ci-operator.yaml and Makefile BUILD_IMAGE"

  - name: "go.mod consistency"
    check: "All k8s.io dependencies at same minor version"

  - name: "getCorrectHostmountAnyUIDSCC function"
    file: "controllers/podplacement/podplacement_controller.go"
    check: "K8s→OCP version mapping aligns with upgrade targets"

# Post-upgrade requirements
post_upgrade:
  - name: "Prow config update"
    description: "May need PR in openshift/release for Prow CI config"
    example: "https://github.com/openshift/release/pull/55728/commits/707fa080a66d8006c4a69e452a4621ed54f67cf6"
    action: "Check if presubmit/postsubmit jobs need golang version updates"

  - name: "Documentation update"
    file: "docs/ocp-release.md"
    action: "Update this document with any process changes discovered during upgrade"