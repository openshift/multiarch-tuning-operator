# Upgrade workflow for multiarch-tuning-operator
#
# This defines the complete step-by-step process for upgrading Go and Kubernetes versions.
# Each step references the patterns and discovery methods defined in other config files.

workflow:
  name: "multiarch-tuning-operator version upgrade"
  description: "Complete automated workflow for upgrading Go and Kubernetes versions"

  inputs:
    required:
      - name: "go_version"
        format: "X.Y (e.g., 1.23)"
        description: "Target Go version (minor version only)"

      - name: "k8s_version"
        format: "X.Y.Z (e.g., 1.32.3)"
        description: "Target Kubernetes version (full semver)"

    optional:
      - name: "repo_path"
        default: "."
        description: "Path to multiarch-tuning-operator repository"

  prerequisites:
    - name: "Clean working directory"
      check: "git status shows no uncommitted changes"
      command: "git status --porcelain"
      fail_if_output: true

    - name: "Extract current versions"
      steps:
        - description: "Current Go version from go.mod"
          command: "grep '^go ' go.mod | awk '{print $2}'"
          store_as: "current_go_version"

        - description: "Current K8s version from go.mod"
          command: "grep 'k8s.io/api' go.mod | head -1 | awk '{print $2}'"
          store_as: "current_k8s_version"

        - description: "Current OCP version from BUILD_IMAGE"
          command: "grep 'BUILD_IMAGE' Makefile | grep -oP 'openshift-\\K[0-9]+\\.[0-9]+'"
          store_as: "current_ocp_version"

    - name: "Validate version compatibility"
      steps:
        - description: "Extract target OCP version from BUILD_IMAGE"
          method: "Use current_ocp_version or derive from target K8s version"
          config_ref: "version-matrix.yaml#kubernetes_to_openshift"

        - description: "Validate K8s version aligns with OCP version"
          method: "Check openshift/api release branch for K8s version"
          config_ref: "version-matrix.yaml#kubernetes_to_openshift.validation"
          fail_if_mismatch: true

        - description: "Validate Go version compatibility"
          method: "Check k8s.io/api, openshift/api, and BUILD_IMAGE requirements"
          config_ref: "version-matrix.yaml#go_version_requirements"
          warn_if_mismatch: true

    - name: "Validate base images exist"
      description: "Ensure all target images are available before making changes"
      images:
        - name: "dockerfile_golang"
          pattern: "golang:{go_version}"
          validation: "docker manifest inspect golang:{go_version}"
          retry_with: ["{go_version}.0", "{go_version}.1", "{go_version}.2"]
          required: true

        - name: "ci_builder"
          patterns:
            - "registry.ci.openshift.org/ocp/builder:rhel-9-golang-{go_version}-openshift-{ocp_version}"
            - "registry.ci.openshift.org/ocp/builder:rhel-9-golang-{go_version}-builder-multi-openshift-{ocp_version}"
          validation: "skopeo inspect docker://{image}"
          note: "May require VPN/registry access"
          required: false

        - name: "brew_builder"
          pattern: "brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_9_{go_version}"
          validation: "skopeo inspect docker://{image}"
          note: "Requires Red Hat VPN and registry authentication"
          required: true

  steps:
    - number: 1
      name: "Update Go version in base images"
      commit_message: "Update Makefile and Dockerfiles to use the new Golang version base image to {go_version}"

      tasks:
        - description: "Update .ci-operator.yaml"
          config_ref: "file-update-patterns.yaml#base_image_updates[0]"
          file: ".ci-operator.yaml"

        - description: "Update .tekton YAML files"
          config_ref: "file-update-patterns.yaml#base_image_updates[1]"
          file_glob: ".tekton/*.yaml"

        - description: "Update Dockerfile"
          config_ref: "file-update-patterns.yaml#base_image_updates[2]"
          file: "Dockerfile"

        - description: "Update Makefile BUILD_IMAGE"
          config_ref: "file-update-patterns.yaml#base_image_updates[3]"
          file: "Makefile"

        - description: "Update bundle.konflux.Dockerfile"
          config_ref: "file-update-patterns.yaml#base_image_updates[4]"
          file: "bundle.konflux.Dockerfile"

        - description: "Update konflux.Dockerfile"
          config_ref: "file-update-patterns.yaml#base_image_updates[5]"
          file: "konflux.Dockerfile"

        - description: "Validate getCorrectHostmountAnyUIDSCC function"
          file: "controllers/podplacement/podplacement_controller.go"
          action: "Search for function and verify K8s→OCP version mapping"
          warn_if_outdated: true
          explanation: "This function relies on K8s version to determine SCC for podplacementconfig pod's hostPath mounts"

      commit:
        files:
          - ".ci-operator.yaml"
          - ".tekton/"
          - "Dockerfile"
          - "Makefile"
          - "bundle.konflux.Dockerfile"
          - "konflux.Dockerfile"
        command: "git add {files} && git commit -m '{commit_message}'"

    - number: 2
      name: "Update go.mod"
      commit_message: "pin K8S API to v{k8s_version} and set go minimum version to {go_version}"

      tasks:
        - description: "Update go directive in go.mod"
          file: "go.mod"
          action: "Set go directive to {go_version}"
          example: "go 1.23"

        - description: "Extract all direct dependencies"
          command: |
            ALL_DEPS=$(grep -E '^\\s+[a-zA-Z0-9]' go.mod | grep -v '^\\s*//' | awk '{print $1}' | sort -u)
          categories:
            - k8s_deps: "k8s.io/*"
            - sigs_deps: "sigs.k8s.io/*"
            - openshift_deps: "github.com/openshift/*"
            - other_deps: "everything else"

        - description: "Update all k8s.io dependencies"
          for_each: "k8s_deps"
          command: "go get {dep}@v{k8s_version}"
          note: "Some k8s.io packages may not have exact version, go get will use nearest compatible"

        - description: "Update controller-runtime"
          config_ref: "version-matrix.yaml#controller_runtime"
          method: "Discover compatible version for K8s and Go versions"
          command: "go get sigs.k8s.io/controller-runtime@{controller_runtime_version}"

        - description: "Update OpenShift API dependencies (if present)"
          condition: "If github.com/openshift/* dependencies exist in go.mod"
          for_each: "openshift_deps"
          command: "go get {dep}@release-{ocp_version}"

        - description: "Update ALL other dependencies to latest compatible"
          for_each: "other_deps"
          command: "go get -u {dep}"
          note: "Uses -u flag to upgrade to latest compatible versions (important for Go version upgrades)"
          includes:
            - "github.com/BurntSushi/toml"
            - "github.com/cilium/ebpf"
            - "github.com/containers/image/v5"
            - "github.com/onsi/ginkgo/v2"
            - "github.com/onsi/gomega"
            - "golang.org/x/*"
            - "google.golang.org/grpc"
            - "all other direct dependencies"

        - description: "Run go mod tidy and verify"
          commands:
            - "go mod tidy"
            - "go mod verify"
          on_conflict:
            example: "opentelemetry v1.38 conflicts"
            action: "Downgrade conflicting packages"
            command: "go get {package}@{compatible_version}"

        - description: "Verify k8s.io version consistency"
          check: "All k8s.io dependencies at same minor version"
          command: |
            VERSIONS=$(grep '^\\s*k8s\\.io/' go.mod | grep -v '//' | awk '{print $2}' | grep -oP 'v\\d+\\.\\d+' | sort -u | wc -l)
          warn_if: "VERSIONS > 1"

        - description: "Consolidate go.mod structure to 2 require blocks"
          note: "Go 1.24+ may create multiple indirect blocks"
          target_structure:
            - "Block 1: Direct dependencies (no // indirect)"
            - "Block 2: Indirect dependencies (with // indirect)"
          method: "Use Python script or go mod edit -fmt"
          commands:
            - "go mod edit -fmt"
            - "Verify 2 require blocks exist"
            - "go mod tidy"
            - "go mod verify"

      commit:
        files:
          - "go.mod"
          - "go.sum"
        command: "git add go.mod go.sum && git commit -m '{commit_message}'"

    - number: 3
      name: "Update vendor folder"
      commit_message: "go mod vendor"

      tasks:
        - description: "Clean and regenerate vendor"
          commands:
            - "rm -rf vendor/"
            - "go mod vendor"

      commit:
        files:
          - "vendor/"
        command: "git add vendor/ && git commit -m '{commit_message}'"

    - number: 4
      name: "Update tools in Makefile"
      commit_message: "Update tools in Makefile"

      tasks:
        - description: "Determine compatible tool versions automatically"
          note: "ALL tool versions are discovered dynamically, NOTHING hardcoded"
          tools:
            - name: "KUSTOMIZE_VERSION"
              config_ref: "version-matrix.yaml#tool_versions.kustomize"
              method: "Find latest v5.x compatible with Go version"

            - name: "CONTROLLER_TOOLS_VERSION"
              config_ref: "version-matrix.yaml#tool_versions.controller_tools"
              method: "Find latest matching K8s API version and Go version"

            - name: "SETUP_ENVTEST_VERSION"
              config_ref: "version-matrix.yaml#tool_versions.setup_envtest"
              method: "Derive from controller-runtime version (release-0.{minor})"

            - name: "ENVTEST_K8S_VERSION"
              config_ref: "version-matrix.yaml#tool_versions.envtest_k8s_version"
              method: "Extract from controller-runtime's k8s.io/api dependency"

            - name: "GOLINT_VERSION"
              config_ref: "version-matrix.yaml#tool_versions.golangci_lint"
              method: "Find latest compatible with Go version"

        - description: "Update Makefile variables"
          for_each: "tool"
          command: "sed -i 's/{tool_name} \\?= .*/{tool_name} ?= {tool_version}/' Makefile"

      commit:
        files:
          - "Makefile"
        command: "git add Makefile && git commit -m '{commit_message}'"

    - number: 5
      name: "Run code generation"
      commit_message: "Code generation after upgrade"

      tasks:
        - description: "Generate code and manifests"
          commands:
            - command: "make generate"
              description: "Generate deepcopy, client, informer, lister code"

            - command: "make manifests"
              description: "Generate CRD, RBAC, webhook manifests"

            - command: "make bundle"
              description: "Generate OLM bundle"

        - description: "Address any warnings or errors"
          note: "Review output for deprecation warnings or API changes"

      commit:
        condition: "If files changed"
        files:
          - "All generated files"
        command: "git add . && git commit -m '{commit_message}'"

    - number: 6
      name: "Run tests and build"
      commit_message: "Update code after Golang, pivot to k8s {k8s_version} and dependencies upgrade"

      tasks:
        - description: "Build and test"
          commands:
            - command: "make docker-build"
              description: "Build container image"
              continue_on_error: false

            - command: "make build"
              description: "Build operator binary"
              continue_on_error: false

            - command: "make test"
              description: "Run unit tests"
              continue_on_error: false

        - description: "Look for deprecation warnings"
          note: "Check controller-runtime repository for PRs about deprecated APIs"
          action: "Address any deprecated API usage found in tests"

        - description: "Fix any code issues discovered"
          condition: "If code changes needed"
          examples:
            - "Update deprecated API usage"
            - "Fix breaking changes in dependencies"
            - "Update operator-specific validation logic"

      commit:
        condition: "Only if code changes were required"
        files:
          - "Modified code files"
        command: "git add . && git commit -m '{commit_message}'"

  post_workflow:
    - name: "Prow config update warning"
      description: "Warn about potential Prow CI config updates"
      message: |
        ⚠️  The PR in this repo may need to be paired with one in the Prow config.
        See example: https://github.com/openshift/release/pull/55728/commits/707fa080a66d8006c4a69e452a4621ed54f67cf6
        Check if openshift/release needs golang version updates for presubmit/postsubmit jobs.

    - name: "Documentation update"
      file: "docs/ocp-release.md"
      action: "Update this document with any process changes discovered during upgrade"

  expected_commit_log:
    example: |
      02eb25dd (HEAD -> update-go) Add info in the ocp-release.md doc about k8s and golang upgrade
      8e2d3389 Add info in the ocp-release.md doc about k8s and golang upgrade
      46e7b338 Update code after Golang, pivot to k8s {k8s_version} and dependencies upgrade
      787dfb2a Update tools in Makefile
      289ebaa2 go mod vendor
      cda73fe1 pin K8S API to v{k8s_version} and set go minimum version to {go_version}
      e511fdce Update go version in base images to {go_version}

    structure:
      - "Update go version in base images to {go_version}"
      - "pin K8S API to v{k8s_version} and set go minimum version to {go_version}"
      - "go mod vendor"
      - "Update tools in Makefile"
      - "Code generation after upgrade (if files changed)"
      - "Update code after Golang, pivot to k8s {k8s_version} and dependencies upgrade (if code changes needed)"
      - "Add info in the ocp-release.md doc about k8s and golang upgrade"